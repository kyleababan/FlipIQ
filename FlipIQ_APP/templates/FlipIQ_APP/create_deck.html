{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Deck - FlipIQ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --yellow:#ffd42d;
      --yellow-dark:#f1c425;
      --brown:#9b6400;
      --bg:#fffdf8;
    }

    body {
      background: var(--bg);
      font-family: "Inter", sans-serif;
      color: #222;
      margin: 0;
      min-height: 100vh;
      padding-bottom: 90px;
    }

    /* ---------- TOP BAR ---------- */
    .topbar {
      background: var(--yellow);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .back-link {
      color: #111;
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .page-title {
      font-weight: 800;
      font-size: 1.2rem;
      margin-left: 10px;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    /* ---------- CARD COUNTER BELOW ---------- */
    .meta-line {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: #111;
      font-weight: 600;
      font-size: 0.95rem;
      margin: 0.8rem 1.8rem;
    }

    /* ---------- CARDS ---------- */
    .page-inner {
      padding: 0 1.5rem;
    }

    .card-edit,
    .card-view {
      border: 2px solid var(--brown);
      border-radius: 14px;
      background: #fff;
      padding: 1rem 1.2rem;
      margin: 1.2rem 0;
      max-width: 850px;
      margin-left: auto;
      margin-right: auto;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
    }

    .card-label {
      font-weight: 700;
      margin-top: .6rem;
    }

    .q-input,
    .a-input,
    .choice-input {
      width: 100%;
      padding: .6rem .9rem;
      border: 2px solid var(--yellow);
      border-radius: 10px;
      outline: none;
      background: #fff;
    }

    .choices-row {
      display: flex;
      gap: .6rem;
      margin-top: .5rem;
      flex-wrap: wrap;
    }

    .btn-add-choice {
      background: var(--yellow);
      border: 0;
      border-radius: 12px;
      padding: .35rem .9rem;
      font-weight: 700;
    }

    .btn-add-choice:hover {
      background: var(--yellow-dark);
    }

    /* Add card button */
    .add-card-wrap {
      text-align: left;
      margin-left: 1.8rem;
      margin-top: 1rem;
    }

    .btn-add-card {
      background: var(--yellow);
      border: 0;
      border-radius: 24px;
      padding: .4rem 1.2rem;
      font-weight: 800;
    }

    .btn-add-card:hover {
      background: var(--yellow-dark);
    }

    /* Floating Publish button */
    .btn-publish {
      position: fixed;
      right: 26px;
      bottom: 20px;
      background: var(--yellow);
      border: 0;
      padding: .6rem 1.2rem;
      border-radius: 24px;
      font-weight: 800;
      z-index: 50;
    }
    .btn-publish:hover {
      background: var(--yellow-dark);
    }

    /* ---------- SAVED VIEW MODE ---------- */
    .card-view .front {
      font-weight: 700;
      margin-bottom: .2rem;
    }
    .card-view .back {
      border-left: 2px solid #000;
      padding-left: .6rem;
      margin-top: .2rem;
      font-weight: 700;
    }
    .card-view .choice-badge {
      background: #eee;
      border-radius: 12px;
      padding: .2rem .8rem;
      margin-right: .3rem;
      margin-top: .3rem;
      font-size: .9rem;
      display: inline-block;
    }

    /* ---------- PUBLISH MODAL ---------- */
    .publish-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .publish-modal.active { display: flex; }

    .publish-box {
      background: #fff;
      border: 2px solid var(--brown);
      border-radius: 16px;
      padding: 2rem;
      width: 500px;
      max-width: 90%;
    }
    .publish-box h4 {
      font-weight: 800;
      border-bottom: 2px solid #000;
      padding-bottom: .3rem;
      margin-bottom: 1.3rem;
    }
    .publish-box select {
      border: 2px solid var(--yellow);
      border-radius: 10px;
      padding: .5rem .7rem;
      width: 100%;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .visibility-box {
      border: 2px solid var(--brown);
      border-radius: 10px;
      padding: .8rem 1rem;
      margin-bottom: .8rem;
    }
    .btn-yellow {
      background: var(--yellow);
      border: none;
      border-radius: 24px;
      padding: .6rem 1.2rem;
      font-weight: 700;
    }
    .btn-yellow:hover { background: var(--yellow-dark); }
    .btn-outline-yellow {
      border: 2px solid var(--yellow);
      background: #fff;
      border-radius: 24px;
      padding: .6rem 1.2rem;
      font-weight: 700;
    }

  </style>
</head>
<body>

  <!-- ---------- HEADER ---------- -->
  <header class="topbar">
    <a href="{% url 'profile' %}" class="back-link"><i class="bi bi-chevron-left"></i> Back</a>
    <div class="page-title">
      <strong id="deckTitleText">Untitled Deck</strong>
      <button class="btn btn-sm" id="editTitleBtn" title="Edit title" style="background:transparent;border:0;">
        <i class="bi bi-pencil"></i>
      </button>
    </div>
  </header>

  <!-- ---------- CARD COUNTER ---------- -->
  <div class="meta-line">
    <i class="bi bi-collection"></i>
    <span id="cardCount">0</span>
  </div>

  <!-- ---------- MAIN CONTENT ---------- -->
  <main class="page-inner">
    <div id="cardsContainer"></div>

    <div class="add-card-wrap">
      <button class="btn-add-card" id="addCardBtn"><i class="bi bi-plus-lg"></i> Add card</button>
    </div>
  </main>

  <button class="btn-publish" id="openPublishModal">Publish</button>

  <!-- ---------- PUBLISH MODAL ---------- -->
  <div class="publish-modal" id="publishModal">
    <div class="publish-box">
      <h4 id="publishTitle">Untitled Deck <i class="bi bi-pencil"></i></h4>
      <div class="row">
        <div class="col-md-6">
          <label class="fw-bold">Time interval per card</label>
          <select id="intervalSelect">
            <option>5 secs</option>
            <option selected>10 secs</option>
            <option>30 secs</option>
            <option>1 min</option>
            <option>2 min</option>
            <option>5 min</option>
            <option>none</option>
          </select>

          <label class="fw-bold">Subject</label>
          <select id="subjectSelect">
            <option>English</option>
            <option>Mathematics</option>
            <option>Science</option>
            <option>Filipino</option>
            <option>Araling Panlipunan</option>
            <option>TLE / EPP</option>
            <option>MAPEH</option>
            <option>ICT</option>
            <option>Values Education</option>
            <option>Reading and Comprehension</option>
            <option>Other</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="fw-bold">Visibility</label>
          <div class="visibility-box">
            <input type="radio" name="visibility" value="public" checked> Public<br>
            <small>This resource will be publicly visible.</small>
          </div>
          <div class="visibility-box">
            <input type="radio" name="visibility" value="private"> Private<br>
            <small>This resource will only be visible to you.</small>
          </div>
        </div>
      </div>

      <div class="text-center mt-3">
        <button class="btn-yellow" id="publishDeckBtn">Publish</button>
        <button class="btn-outline-yellow" id="cancelPublish">Cancel</button>
      </div>
    </div>
  </div>

<script>
  const container = document.getElementById('cardsContainer');
  const cardCount = document.getElementById('cardCount');
  const publishModal = document.getElementById('publishModal');
  const deckId = "{{ deck_id|default:'' }}"; // detect edit mode

  function updateCount() {
    const cards = container.querySelectorAll('.card-edit, .card-view');
    cardCount.textContent = cards.length;
    cards.forEach((card, index) => {
      const num = card.querySelector('.card-number');
      if (num) num.textContent = index + 1;
      card.setAttribute('data-index', index + 1);
    });
  }

  document.getElementById('addCardBtn').addEventListener('click', () => {
    const idx = container.children.length + 1;
    const card = document.createElement('div');
    card.className = 'card-edit';
    card.setAttribute('data-index', idx);
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong class="card-number">${idx}</strong></div>
        <div>
          <button class="btn btn-sm" onclick="saveCard(this)"><i class="bi bi-save"></i></button>
          <button class="btn btn-sm" onclick="removeCard(this)"><i class="bi bi-trash"></i></button>
        </div>
      </div>
      <div class="mt-2">
        <div class="card-label">Front</div>
        <input class="q-input" placeholder="Write your Question here">
      </div>
      <div class="mt-2">
        <div class="card-label">Back (Correct Answer)</div>
        <input class="a-input" placeholder="Type here">
      </div>
      <div class="mt-2">
        <div class="card-label">Choices:</div>
        <div class="choices-row">
          <input class="choice-input" placeholder="Type here">
          <button class="btn-add-choice" onclick="addChoice(this)">+ Add choice</button>
        </div>
      </div>`;
    container.appendChild(card);
    updateCount();
  });

  function addChoice(btn) {
    const row = btn.closest('.choices-row');
    const input = document.createElement('input');
    input.className = 'choice-input';
    input.placeholder = 'Type here';
    row.insertBefore(input, btn);
  }

  function saveCard(btn) {
    const card = btn.closest('.card-edit');
    const q = card.querySelector('.q-input').value.trim();
    const a = card.querySelector('.a-input').value.trim();
    const choices = [...card.querySelectorAll('.choice-input')].map(i => i.value.trim()).filter(Boolean);
    const idx = card.getAttribute('data-index');
    const view = document.createElement('div');
    view.className = 'card-view';
    view.setAttribute('data-index', idx);
    view.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong class="card-number">${idx}</strong></div>
        <div>
          <button class="btn btn-sm" onclick="editCard(this)"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm" onclick="removeCard(this)"><i class="bi bi-trash"></i></button>
        </div>
      </div>
      <div style="margin-top:.5rem;">
        <div class="front"><span style="font-weight:700;">Front</span><br>${q}</div>
        <div class="back"><span style="font-weight:700;">Back</span><br>${a}</div>
        <div style="margin-top:.5rem;">
          <div style="font-weight:700;">Choices:</div>
          ${choices.map(c => `<span class="choice-badge">${c}</span>`).join('')}
        </div>
      </div>`;
    card.replaceWith(view);
    updateCount();
  }

  function editCard(btn) {
    const view = btn.closest('.card-view');
    const idx = view.getAttribute('data-index');
    const q = view.querySelector('.front').innerHTML.replace(/<[^>]+>/g, '').replace(/^Front/, '').trim();
    const a = view.querySelector('.back').innerHTML.replace(/<[^>]+>/g, '').replace(/^Back/, '').trim();
    const choices = [...view.querySelectorAll('.choice-badge')];
    const card = document.createElement('div');
    card.className = 'card-edit';
    card.setAttribute('data-index', idx);
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong class="card-number">${idx}</strong></div>
        <div>
          <button class="btn btn-sm" onclick="saveCard(this)"><i class="bi bi-save"></i></button>
          <button class="btn btn-sm" onclick="removeCard(this)"><i class="bi bi-trash"></i></button>
        </div>
      </div>
      <div class="mt-2">
        <div class="card-label">Front</div>
        <input class="q-input" value="${q}">
      </div>
      <div class="mt-2">
        <div class="card-label">Back (Correct Answer)</div>
        <input class="a-input" value="${a}">
      </div>
      <div class="mt-2">
        <div class="card-label">Choices:</div>
        <div class="choices-row">
          ${choices.map(c => `<input class='choice-input' value='${c.innerText}'>`).join('')}
          <button class="btn-add-choice" onclick="addChoice(this)">+ Add choice</button>
        </div>
      </div>`;
    view.replaceWith(card);
    updateCount();
  }

  function removeCard(btn) {
    btn.closest('.card-edit, .card-view').remove();
    updateCount();
  }

  // ---------- PUBLISH MODAL ----------
  document.getElementById('openPublishModal').onclick = () => publishModal.classList.add('active');
  document.getElementById('cancelPublish').onclick = () => publishModal.classList.remove('active');

  // ---------- AJAX SUBMIT ----------
  document.getElementById('publishDeckBtn').addEventListener('click', async () => {
    const deckTitle = document.getElementById('deckTitleText').textContent.trim();
    const interval = document.getElementById('intervalSelect').value;
    const subject = document.getElementById('subjectSelect').value;
    const visibility = document.querySelector('input[name="visibility"]:checked').value;

    const cards = [...container.querySelectorAll('.card-view')].map(c => ({
      front: c.querySelector('.front')?.innerText.replace('Front', '').trim() || '',
      back: c.querySelector('.back')?.innerText.replace('Back', '').trim() || '',
      choices: [...c.querySelectorAll('.choice-badge')].map(ch => ch.innerText)
    }));

    const payload = { deckTitle, interval, subject, visibility, cards };
    if (deckId) payload.deckId = deckId; // send deckId when editing

    const response = await fetch('/publish_deck/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      window.location.href = "{% url 'profile' %}";
    } else {
      alert('Failed to publish deck.');
    }
  });

  // ---------- EDITABLE TITLE ----------
  const deckTitleText = document.getElementById("deckTitleText");
  const editTitleBtn = document.getElementById("editTitleBtn");
  const publishTitle = document.getElementById("publishTitle");

  editTitleBtn.addEventListener("click", () => {
    const currentTitle = deckTitleText.textContent.trim();
    const newTitle = prompt("Enter deck title:", currentTitle);
    if (newTitle !== null && newTitle.trim() !== "") {
      deckTitleText.textContent = newTitle.trim();
      publishTitle.innerHTML = `${newTitle.trim()} <i class="bi bi-pencil"></i>`;
    }
  });

  // ---------- LOAD EXISTING DECK WHEN EDITING ----------
  if (deckId) {
    fetch(`/get-deck-data/${deckId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('deckTitleText').textContent = data.title || "Untitled Deck";
        document.getElementById('intervalSelect').value = data.interval || "10 secs";
        document.getElementById('subjectSelect').value = data.subject || "Other";
        document.querySelector(`input[name="visibility"][value="${data.visibility}"]`).checked = true;

        data.cards.forEach((c, i) => {
          const card = document.createElement('div');
          card.className = 'card-view';
          card.setAttribute('data-index', i + 1);
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong class="card-number">${i + 1}</strong></div>
              <div>
                <button class="btn btn-sm" onclick="editCard(this)"><i class="bi bi-pencil-square"></i></button>
                <button class="btn btn-sm" onclick="removeCard(this)"><i class="bi bi-trash"></i></button>
              </div>
            </div>
            <div style="margin-top:.5rem;">
              <div class="front"><span style="font-weight:700;">Front</span><br>${c.front}</div>
              <div class="back"><span style="font-weight:700;">Back</span><br>${c.back}</div>
              <div style="margin-top:.5rem;">
                <div style="font-weight:700;">Choices:</div>
                ${c.choices.map(choice => `<span class="choice-badge">${choice}</span>`).join('')}
              </div>
            </div>`;
          container.appendChild(card);
        });
        updateCount();
      });
  }

  updateCount();
</script>

</body>
</html>
